!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).PageChannel=t()}(this,function(){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var s=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};n(this,t),this.$options=e,this.targetOrigin=e.targetOrigin,this.otherWindow=this.$options.otherWindow,this.isChannel=this.$options.isChannel,this.targetUrl=this.$options.targetUrl,this._init()}return e(t,[{key:"_init",value:function(){var n=this;window.addEventListener("message",this.receiveMessage.bind(this),!1),this.isChannel&&window.addEventListener("storage",function(e){console.log("收到数据变化",e,n);var t=JSON.parse(e.newValue);n.targetOrigin=t.targetUrl,n.postMessage(t)})}},{key:"receiveMessage",value:function(e){console.log(window.location.href,"收到",!this.isChannel),(this.targetOrigin||"").indexOf(e.origin)<0&&!this.isChannel||(this.$options.receive.call(this,e.data),this.isChannel&&(this.targetOrigin=e.origin,this._changeStorage(e.data)))}},{key:"_changeStorage",value:function(e){console.log("存在缓存中的：",e),localStorage.setItem(e.targetUrl,JSON.stringify(e))}},{key:"setReceive",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){};this.$options.receive=e}},{key:"postMessage",value:function(e){console.log(window.location.href,"发送"),this.otherWindow.postMessage(e,this.targetOrigin)}}]),t}(),o=function(){},t=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};n(this,t),this.$isChannel=e.isChannel||!1,this.$options=e,this.$events={getMessage:o,error:o},this._init()}return e(t,[{key:"_init",value:function(){this.$isChannel?this.message=new s({receive:this.$events.getMessage,otherWindow:window.parent,isChannel:this.$isChannel}):(this._appendIframe(),this.message=new s({targetOrigin:this.$options.channelUrl,receive:this.$events.getMessage,otherWindow:this.iframe.contentWindow}))}},{key:"_appendIframe",value:function(){var e=document.createElement("iframe");e.src=this.$options.channelUrl,e.style.display="none",document.body.appendChild(e),this.iframe=e}},{key:"on",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};this.$events[e]=t,"getMessage"==e&&this.message&&this.message.setReceive(t)}},{key:"sendMessage",value:function(e){this.message.postMessage({data:e,targetUrl:this.$options.targetUrl,time:Date.now()})}}]),t}();return t.version="0.0.1beta",t});
